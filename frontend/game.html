<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Phaser</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.87.0/dist/phaser.js"></script>
    <style type="text/css">
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script type="module">
      import CollisionBlocks from "./collisionBlocks.js";
      import HouseCollisionBlocks from "./houseCollisionBlocks.js";
      class MainScene extends Phaser.Scene {
        constructor() {
          super({ key: "Main" });
        }

        // Character positioning
        init(data) {
          // Defaults guy start position to 900/800 unless switching scene
          this.startX = data && data.x ? data.x : 1000; // Default to 900 if no position passed
          this.startY = data && data.y ? data.y : 1200; // Default to 800 if no position passed
        }

        preload() {
          this.load.spritesheet("background", "assets/background.png", {
            frameWidth: 630,
            frameHeight: 500,
          });
          this.load.spritesheet("guy", "assets/guy.png", {
            frameWidth: 32,
            frameHeight: 32,
          });
          this.load.image("collision", "assets/collision.png");
          this.load.image("roof1", "assets/rooftoop.png")
          this.load.image("roof2", "assets/Rooftop2.1.png")
        }

        create() {
          // Character animations/frames

          this.anims.create({
            key: "guyidle",
            frames: this.anims.generateFrameNumbers("guy", {
              start: 0,
              end: 0,
            }),
            frameRate: 1,
          });

          this.anims.create({
            key: "background",
            frames: this.anims.generateFrameNumbers("background", {
              start: 0,
              end: 79,
            }),
            frameRate: 8,
            repeat: -1, // Loops through indefinitely
          });

          const background = this.add
            .sprite(0, 0, "background")
            .setOrigin(0, 0)
            .setScale(3.2); // How zoomed in the map is

          background.play("background");

          this.roof = this.add
            .image(1251, 432, "roof1")
            .setOrigin(0, 0)
            .setDepth(10)
            .setScale(0.5);
          this.roof1 = this.add
            .image(334, 943, "roof2")
            .setOrigin(0, 0)
            .setDepth(10)
            .setScale(0.59);

          this.player = this.physics.add
            .sprite(this.startX, this.startY, "guy")
            .setSize(18, 10)
            .setScale(2.5) // Size of character
            .setOrigin(0, 0) // Do not change
            .setOffset(6.5, 14); // Do not change

          this.player.setCollideWorldBounds(true);

          this.anims.create({
            key: "left",
            frames: this.anims.generateFrameNumbers("guy", {
              start: 24,
              end: 29,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: "right",
            frames: this.anims.generateFrameNumbers("guy", {
              start: 24,
              end: 29,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: "up",
            frames: this.anims.generateFrameNumbers("guy", {
              start: 30,
              end: 35,
            }),
            frameRate: 10,
            repeat: -1,
          });

          this.anims.create({
            key: "down",
            frames: this.anims.generateFrameNumbers("guy", {
              start: 18,
              end: 23,
            }),
            frameRate: 10,
            repeat: -1,
          });

          // Collision and door data
          this.collisionBlocks = this.physics.add.staticGroup();
          this.doorArea = this.physics.add.staticGroup();

          const collisionBlocks = new CollisionBlocks(this);
          // Get the group of collision blocks from collisionBlocks.js
          const collisionGroup = collisionBlocks.getBlocks();
          // Player & Collision Blocks collide
          this.physics.add.collider(this.player, this.collisionBlocks);
          this.physics.add.collider(this.player, collisionGroup);

          // Door block
          this.doorArea
            .create(495, 665, "collision")
            .setSize(40, 60)
            .setOrigin(1, 1); // House door TL

          this.doorArea
            .create(1315, 695, "collision")
            .setSize(40, 60)
            .setOrigin(1, 1); // House door TR

          // Change to true to see door hitboxes
          this.collisionBlocks.children.iterate((child) => {
            child.setVisible(true);
          });

          // Player to door teleport
          this.physics.add.collider(
            this.player,
            this.doorArea,
            function (player, doorArea) {
              if (doorArea === this.doorArea.getChildren()[0]) {
                console.log("You are close to the house door!");
                this.scene.start("House"); // Switch to House
              }
            },
            null,
            this
          );

          // World bounds and camera
          this.physics.world.setBounds(0, 0, 2000, 1600);
          this.cameras.main.setBounds(0, 0, 2000, 1600);
          this.cameras.main.startFollow(this.player);

          this.cursors = this.input.keyboard.createCursorKeys();
        }

        update() {
          this.player.setVelocity(0);

          if (this.cursors.left.isDown) {
            this.player.setVelocityX(-160);
            this.player.anims.play("right", true);
            this.player.setFlipX(true);
          } else if (this.cursors.right.isDown) {
            this.player.setVelocityX(160);
            this.player.anims.play("right", true);
            this.player.setFlipX(false);
          }

          if (this.player.body.velocity.x === 0) {
            if (this.cursors.up.isDown) {
              this.player.setVelocityY(-160);
              this.player.anims.play("up", true);
            } else if (this.cursors.down.isDown) {
              this.player.setVelocityY(160);
              this.player.anims.play("down", true);
            }
          }

          if (
            this.player.body.velocity.x === 0 &&
            this.player.body.velocity.y === 0
          ) {
            this.player.anims.play("guyidle", true);
          }
        }
      }

      class HouseScene extends Phaser.Scene {
        constructor() {
          super({ key: "House" });
        }

        preload() {
          this.load.image("house2", "assets/house2.png");
          this.load.spritesheet("guy", "assets/guy.png", {
            frameWidth: 32,
            frameHeight: 32,
          });
          this.load.image("collision", "assets/collision.png");
        }

        create() {
          this.cursors = this.input.keyboard.createCursorKeys();

          // House image
          this.add.image(0, 0, "house2").setOrigin(0, 0).setScale(0.5);

          this.player = this.physics.add
            .sprite(200, 300, "guy")
            .setSize(18, 10)
            .setScale(3.5)
            .setOrigin(0, 0)
            .setOffset(6.5, 14);

          this.player.setCollideWorldBounds(true);

          const houseCollisionBlocks = new HouseCollisionBlocks(this);

          this.physics.add.collider(
            this.player,
            this.doorArea,
            function (player, doorArea) {
              console.log("You are at the door!");
              this.scene.start("Main", { x: 500, y: 685 });
            },
            null,
            this
          );
          const houseCollisionGroup = HouseCollisionBlocks.getHouseBlocks();
          // Player & Collision Blocks collide
          this.physics.add.collider(this.player, this.collisionBlocks);
          this.physics.add.collider(this.player, houseCollisionGroup);

          // Add house door collision area
          this.doorArea = this.physics.add.staticGroup();
          this.doorArea.create(250, 160, "collision").setSize(50, 70);

          this.physics.world.setBounds(0, 0, 500, 800);
          this.cameras.main.setBounds(0, 0, 500, 800);
        }

        update() {
          this.player.setVelocity(0);

          if (this.cursors.left.isDown) {
            this.player.setVelocityX(-160);
            this.player.anims.play("right", true);
            this.player.setFlipX(true);
          } else if (this.cursors.right.isDown) {
            this.player.setVelocityX(160);
            this.player.anims.play("right", true);
            this.player.setFlipX(false);
          }

          if (this.player.body.velocity.x === 0) {
            if (this.cursors.up.isDown) {
              this.player.setVelocityY(-160);
              this.player.anims.play("up", true);
            } else if (this.cursors.down.isDown) {
              this.player.setVelocityY(160);
              this.player.anims.play("down", true);
            }
          }

          if (
            this.player.body.velocity.x === 0 &&
            this.player.body.velocity.y === 0
          ) {
            this.player.anims.play("guyidle", true);
          }
        }
      }

      // Game configuration
      var config = {
        type: Phaser.AUTO,
        width: 1000,
        height: 600,
        physics: {
          default: "arcade",
          arcade: {
            debug: false, // Set to true to debug/see hitboxes
          },
        },
        scene: [MainScene, HouseScene],
      };

      var game = new Phaser.Game(config);
    </script>
  </body>
</html>
